# Модуль 5 — Продакшн: карта понимания

```
┌─────────────────────────────────────────────────────────────┐
│  ПРОДАКШН как камеры на кухне: видно, что готовится         │
│  и где ошибка                                                │
├────────────┬────────────┬────────────┬──────────────────────┤
│ Якорь     │ Механика   │ Прорыв     │ Применение           │
│ 3 сек     │ 20 сек     │ ✨ 5 сек   │ 10 сек               │
│ Видеозапись│ Трассировка│ Повторить  │ Caching, retries,    │
│            │ LangSmith  │ эксперимент │ deployment            │
└────────────┴────────────┴────────────┴──────────────────────┘
```

---

## 🎯 Якорь + эмоциональный мостик

**🎯 ЯКОРЬ:** Камеры на кухне ресторана — шеф видит каждый шаг. Если блюдо не то, он смотрит запись и находит момент ошибки. Трассировка LLM — то же: видишь промпт, ответ, где «поломалось».

💡 **Эмпатия:** «Звучит как surveillance? Сейчас станет проще, чем включить логи в приложении.»

---

## 📖 Термины и понятия

| Термин | Что это | Метафора |
|--------|---------|----------|
| **Трассировка** | Запись каждого шага: промпт, ответ, время. | 📹 Камера на кухне |
| **LangSmith** | Облако LangChain: логи, промпты, латенция. | 📊 Приборная панель |
| **Trace / Spans** | Один запуск = trace, шаги = spans. | 📁 Папка с вложенными файлами |
| **Caching** | Повторный запрос → из кэша, без API. | 📑 Закладка в книге |
| **Rate limit** | Лимит запросов/мин. От перегрузки. | 🚦 Ограничитель скорости |
| **Retries** | Повтор при ошибке. Backoff = пауза растёт. | 🔄 «Повторить» при сбое |

---

## 🔷 Прогрессивная схема (3 фазы)

#### Фаза 1: Трассировка
```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Запрос     │ ─→  │   Chain      │ ─→  │   LangSmith  │
│   пользователя│     │   (промпт+LLM)│     │   (логи)     │
└──────────────┘     └──────────────┘     └──────────────┘
```

#### Фаза 2: Caching + Rate limit
```
┌──────────────┐
│  Эмбеддинги  │  повторный запрос?
└──────┬───────┘
       ↓
┌──────────────┐
│  Cache       │  ← hit = не вызываем API
└──────┬───────┘
       ↓
┌──────────────┐
│  Rate limit  │  ← защита от перегрузки
└──────────────┘
```

#### Фаза 3: Прорыв ← ✨ ВОТ ЗДЕСЬ МАГИЯ!
```
┌──────────────┐
│  Дебаг       │  смотрю в LangSmith: какой промпт ушёл?
└──────┬───────┘
       ↓
✨ Без трассировки — «чёрный ящик»
   С трассировкой — вижу каждый шаг, могу повторить
```

---

## 📊 Таблица контрастов

| Что думают ❌ | Что на самом деле ✅ | Визуальная метафора |
|---------------|---------------------|----------------------|
| «Логи = print» | LangSmith = полная цепочка (промпт, ответ, латенция) | `Камера vs дневник` |
| «Кэш не нужен» | Повторные эмбеддинги = лишние $ и время | `Закладка в книге` |
| «Rate limit = ограничение» | Защита от перегрузки и баннов | `Ограничитель скорости` |
| «Деплой = просто запуск» | Retries, fallback, мониторинг | `Подушка безопасности` |

---

## 💻 Мини-код с комментариями-стрелками

```python
# ← 1. Включить трассировку (флаг)
os.environ["LANGCHAIN_TRACING_V2"] = "true"
# ← 2. Ключ → доступ к логам в LangSmith
os.environ["LANGCHAIN_API_KEY"] = getpass("Введите ключ: ")
# ← 3. Цепочка автоматически логируется
chain = prompt | llm | StrOutputParser()
result = chain.invoke({})  # ← 4. Вызов → появляется в LangSmith
#        ↑
#        └─── ✨ ВОТ ЗДЕСЬ МАГИЯ: видишь промпт, ответ, время
```

---

## ✅ Чек-лист самопроверки

```
✅ Проверь себя за 15 секунд:
▫️ Могу объяснить трассировку через метафору «камера на кухне»
▫️ Знаю, что нужно для LangSmith (TRACING_V2 + API_KEY)
▫️ Понимаю, зачем кэш эмбеддингов (экономия и скорость)
▫️ Могу включить retries для отказоустойчивости
▫️ Вижу разницу: без трасс = чёрный ящик

→ Если 4+ галочки — уверенно владеешь основой.
```

---

## 🔍 Микро-проверка

**Вопрос:** Зачем трассировка, если можно print?  
**Ответ:** Trace = полная цепочка в UI: промпт, ответ, латенция, вложенность. print — разрозненные строки. Как дневник vs камера наблюдения.

**Вопрос:** Почему кэш эмбеддингов важен?  
**Ответ:** Один и тот же вопрос — десятки раз. Без кэша — десятки вызовов API (деньги + время). С кэшем — один вызов.

---

## ⚠️ Частые ошибки

| Ошибка | Решение |
|--------|---------|
| Трассы не видны в LangSmith | `LANGCHAIN_TRACING_V2="true"` + `LANGCHAIN_API_KEY` до импорта |
| Кэш не работает | Убедись, что эмбеддинг-модель та же, и cache включён в chain |

---

## ➡️ Что дальше

- **ДЗ 12** — RAG + Langfuse (альтернатива LangSmith).
- **Практика:** добавь retries к своей цепочке, посмотри трассу ошибки.

**≈40 мин** — блокноты | **≈1 ч** — трассировка своего приложения

---

## 📁 Блокноты модуля

| Файл | Якорь | Что делаем |
|------|-------|-------------|
| `01_tracing_langsmith.ipynb` | Запись с камеры | Трассировка в LangSmith |
| `02_caching_rate_limit.ipynb` | Закладка + ограничитель | Cache, rate limit |
| `03_testing_evaluation.ipynb` | Тесты и метрики | Качество |
| `04_deployment_miniserver.ipynb` | Подушка безопасности | Деплой |
| `05_retries_backoff.ipynb` | Повторить при ошибке | Retries |

---

**Попробуй:** открой `01_tracing_langsmith.ipynb` и посмотри трассу в LangSmith.
