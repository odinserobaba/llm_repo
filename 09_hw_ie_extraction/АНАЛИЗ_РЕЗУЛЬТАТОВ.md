# Анализ результатов IE (Information Extraction)

**Файл с результатами:** `ie_extraction_hw_result_2.ipynb`  
**Дата:** анализ выполнен по результатам прогона в Colab.

> **Обновление:** В `ie_extraction_hw.ipynb` добавлена фильтрация **только русских диалогов** (language=ru) и русскоязычный промпт для IE.

---

## 1. Производительность

| Показатель | Значение |
|------------|----------|
| Модель | Mistral-7B-Instruct-v0.2 (4-bit) |
| Диалогов обработано | 10 |
| Время выполнения | 130 сек |
| Скорость | ~0,08 диалогов/сек (~13 сек на один диалог) |
| VRAM (пиковое) | 12,33 GB |
| Загружено диалогов из датасета | 185 (после фильтра: длина > 50 символов) |

---

## 2. Парсинг JSON — 0% успешных

**Проблема:** Все 10 примеров попали в `raw` — ни один не распарсился как валидный JSON.

**Причина:** Модель выдаёт корректный JSON в начале ответа, но затем добавляет пояснения и иногда второй JSON-блок:

```
{
  "PERSON": ["I", "you"],
  "ORG": [],
  "LOC": ["desired reality"],
  ...
}

Example of a specific location:

{
  "PERSON": ["I", "you"],
  "LOC": ["The Enchanted Isle of Seraphina"],
  ...
}
```

Старый парсер (regex) не справлялся с таким форматом и считал результат невалидным.

---

## 3. Что на самом деле извлекала модель

В сыром выводе (`raw`) видно, что модель **реально извлекает сущности**:

| Пример | PERSON | LOC | EVENT | Прочее |
|--------|--------|-----|-------|--------|
| 1 (reality shifting) | I, you | desired reality, The Enchanted Isle of Seraphina | reality shifting | IMPACT: save the president's daughter |
| 2 (пляж) | — | playa | — | SOURCE: Amazon (ошибка) |
| 6 (цвета) | — | — | — | — |

**Ошибки в качестве:**
- **PERSON:** "I", "you" — местоимения, а не имена людей.
- **SOURCE:** "text", "Amazon" — не из исходного текста.
- **LOC:** "desired reality" — абстракция, а не географическое место.

---

## 4. Внесённые исправления

### 4.1 Парсер JSON

В функции `extract_entities` вместо regex используется **подсчёт скобок** `{` и `}`: извлекается первый полный JSON-объект, даже если после него идёт дополнительный текст. Это повышает долю успешно распарсенных ответов.

### 4.2 Промпт

В инструкцию добавлено: *"Output ONLY valid JSON, no other text."* — чтобы модель не дописывала пояснения после JSON.

---

## 5. Рекомендации

| Что проверить | Зачем |
|---------------|-------|
| Доля валидного JSON после исправления | Убедиться, что парсер работает |
| PERSON без местоимений | Добавить правило: не считать I, you, we, они |
| SOURCE только из текста | Проверять, что значение встречается в исходном диалоге |
| LOC только географическое | При необходимости фильтровать абстракции вроде "desired reality" |

---

## 6. Краткий вывод

- **Скорость:** ~13 сек/диалог на Mistral 4-bit в Colab T4 — приемлемо для демо, для больших объёмов лучше TinyLlama.
- **Качество:** Модель извлекает сущности, но нужно уточнять промпт и post-processing для фильтрации шума.
- **Парсер:** Обновлённый парсер по скобкам должен заметно уменьшить долю `raw` в следующих прогонах.
