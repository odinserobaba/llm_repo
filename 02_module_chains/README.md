# Модуль 2 — Chains: карта понимания

```
┌─────────────────────────────────────────────────────────────┐
│  CHAINS как конвейер на кухне: помыл → нарезал → подал      │
├────────────┬────────────┬────────────┬──────────────────────┤
│ Якорь     │ Механика   │ Прорыв     │ Применение           │
│ 3 сек     │ 20 сек     │ ✨ 5 сек   │ 10 сек               │
│ Конвейер  │ LCEL       │ Fallback   │ Streaming для UX    │
└────────────┴────────────┴────────────┴──────────────────────┘
```

---

## 🎯 Якорь + эмоциональный мостик

**🎯 ЯКОРЬ:** Бургер собирают по шагам: булка → котлета → соус. Если поменять порядок — получится каша. Цепочки в LLM работают так же: шаг за шагом, в строгой последовательности.

💡 **Эмпатия:** «Звучит как программирование? Сейчас станет проще, чем собрать сэндвич по инструкции.»

---

## 📖 Термины и понятия

| Термин | Что это | Метафора |
|--------|---------|----------|
| **Chain** | Промпт → LLM → парсер. Выход одного = вход следующего. | 🔗 Конвейер на кухне |
| **LCEL** | Синтаксис `chain = a \| b \| c` для пайплайнов. | 🧩 Лего для цепочек |
| **Роутер** | Выбор ветки: «support» → chain A, «sales» → chain B. | 🚦 Диспетчер |
| **Fallback** | Запасная модель при сбое основной. | 🔦 Запасной фонарик |
| **Streaming** | Ответ по токенам, не целиком. Быстрый первый отклик. | 📺 Прямой эфир |
| **LangSmith** | Логи трассировок в облаке. | 📹 Камера наблюдения |
| **invoke** | Вызов цепочки: `chain.invoke({...})`. | ▶️ Кнопка «Старт» |

---

## 📐 Радиальная карта модуля

```
                         ┌──────────────────┐
                         │   CHAINS         │ ← ЦЕНТР
                         │   (Модуль 2)     │
                         └────────┬─────────┘
              ┌───────────────────┼───────────────────┐
              ↓                   ↓                   ↓
       ┌────────────┐     ┌────────────┐     ┌────────────┐
       │ Последова- │     │ Маршрути-  │     │ Устойчивость│
       │ тельность  │     │ зация      │     │ + поток     │
       └─────┬──────┘     └─────┬──────┘     └─────┬──────┘
             ↓                  ↓                   ↓
       • Очистка          • Роутер             • Fallback
       • Сумма            • Ветки              • Streaming
       • Классификация    • Fallback
```

---

## 🔷 Прогрессивная схема (3 фазы)

#### Фаза 1: Последовательная цепочка
```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Текст      │ ─→  │   Очистка    │ ─→  │  Суммаризация│
│   входной    │     │              │     │              │
└──────────────┘     └──────────────┘     └──────┬───────┘
                                                  ↓
                                          ┌──────────────┐
                                          │ Классификация│ ← Тег
                                          └──────────────┘
```

#### Фаза 2: Маршрутизация
```
┌──────────────┐
│   Запрос    │
└──────┬───────┘
       ↓
┌──────────────┐
│   Роутер     │  ← ключевые слова → выбор ветки
└──────┬───────┘
       ├──────────┬──────────┬──────────┐
       ↓          ↓          ↓          ↓
  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
  │ Support│ │ Sales  │ │ Billing │ │ Default│
  └────────┘ └────────┘ └────────┘ └────────┘
```

#### Фаза 3: Прорыв ← ✨ ВОТ ЗДЕСЬ МАГИЯ!
```
┌──────────────┐
│ Модель A    │  (основная)
└──────┬───────┘
       │ ошибка?
       ↓
┌──────────────┐
│ Модель B    │  (fallback) ← ✨ Пользователь ВСЕГДА получает ответ
└──────────────┘

Streaming: токены → экран ПОСТЕПЕННО (быстрый отклик)
```

---

## 📊 Таблица контрастов

| Что думают ❌ | Что на самом деле ✅ | Визуальная метафора |
|---------------|---------------------|----------------------|
| «Один промпт решит всё» | Сложная задача = цепочка шагов | `Конвейер = помыл → нарезал → подал` |
| «Один путь для всех запросов» | Роутер выбирает ветку по типу | `Диспетчер = машина → куда везти` |
| «Модель упала = конец» | Fallback переключает на запасную | `Запасной фонарик при отключении света` |
| «Ждать полный ответ» | Streaming показывает токены по мере появления | `Текстовый редактор vs печать целиком` |

---

## 💻 Мини-код с комментариями-стрелками

```python
# ← 1. LCEL: цепочка через | (pipe)
chain = clean_prompt | llm | summarize_prompt | llm
#       ↑            ↑    ↑
#       └── шаг 1 ──┴────┴── шаг 2 ← ✨ ВОТ ЗДЕСЬ МАГИЯ: читаемый пайплайн

# ← 2. Роутер: условие → ветка
branch = RunnableBranch(
    (is_support, support_chain),   # ← 3. Если support — эта ветка
    (is_sales, sales_chain),      # ← 4. Иначе если sales — эта
    default_chain,                # иначе — дефолт
)

# ← 5. Fallback: основной → запасной
safe_llm = primary_llm.with_fallbacks([backup_llm])
```

---

## ✅ Чек-лист самопроверки

```
✅ Проверь себя за 15 секунд:
▫️ Могу объяснить Chains через метафору «конвейер на кухне»
▫️ Вижу разницу между последовательной цепочкой и роутером
▫️ Знаю, где прорыв (✨ Fallback = ответ даже при сбое)
▫️ Могу добавить новую ветку в RouterBranch
▫️ Понимаю, зачем streaming (быстрый отклик для UX)

→ Если 4+ галочки — уверенно владеешь основой.
```

---

## 🔍 Микро-проверка

**Вопрос:** Зачем fallback, если модель обычно работает?  
**Ответ:** Сеть, API, таймауты — бывают сбои. Fallback даёт пользователю ответ вместо ошибки. Как запасной фонарик при отключении света.

**Вопрос:** Что такое LCEL и зачем `|`?  
**Ответ:** LCEL = LangChain Expression Language. `a | b | c` = «a передаёт вывод в b, b в c». Читаемый пайплайн без вложенных вызовов.

---

## ⚠️ Частые ошибки

| Ошибка | Решение |
|--------|---------|
| Fallback не срабатывает — одна модель на всё | `primary.with_fallbacks([backup])` — явно передай запасную |
| Роутер возвращает не ту ветку | Проверь порядок условий: первое совпадение «съедает» запрос |

---

## ➡️ Что дальше

- **Модуль 3** — Агенты и Tools: цепочка + выбор инструментов.
- **Практика:** добавь fallback к своей chain и посмотри в LangSmith.

**≈30 мин** — блокноты | **≈1 ч** — свой роутер с 2–3 ветками

---

## 📁 Блокноты модуля

| Файл | Якорь | Что делаем |
|------|-------|-------------|
| `01_sequential_chain.ipynb` | Бургер по шагам | Очистка → Сумма → Тег |
| `02_router_chain.ipynb` | Диспетчер машин | Запрос → Роутер → Ветка |
| `03_fallbacks_streaming.ipynb` | Запасной фонарик | Fallback + Stream |

---

**Попробуй:** открой `01_sequential_chain.ipynb` и пройди его сверху вниз.
